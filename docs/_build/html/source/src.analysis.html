
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>src.analysis package &#8212; ml_drought  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="src-analysis-package">
<h1>src.analysis package<a class="headerlink" href="#src-analysis-package" title="Permalink to this headline">¶</a></h1>
<div class="section" id="subpackages">
<h2>Subpackages<a class="headerlink" href="#subpackages" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="src.analysis.indices.html">src.analysis.indices package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-anomaly-index-module">src.analysis.indices.anomaly_index module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-base-module">src.analysis.indices.base module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-china-z-index-module">src.analysis.indices.china_z_index module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-decile-index-module">src.analysis.indices.decile_index module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-drought-severity-index-module">src.analysis.indices.drought_severity_index module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-percent-normal-index-module">src.analysis.indices.percent_normal_index module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-spi-module">src.analysis.indices.spi module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-utils-module">src.analysis.indices.utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#src-analysis-indices-z-score-module">src.analysis.indices.z_score module</a></li>
<li class="toctree-l2"><a class="reference internal" href="src.analysis.indices.html#module-contents">Module contents</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="src-analysis-evaluation-module">
<h2>src.analysis.evaluation module<a class="headerlink" href="#src-analysis-evaluation-module" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="module-src.analysis.event_detector">
<span id="src-analysis-event-detector-module"></span><h2>src.analysis.event_detector module<a class="headerlink" href="#module-src.analysis.event_detector" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="src.analysis.event_detector.EventDetector">
<em class="property">class </em><code class="sig-prename descclassname">src.analysis.event_detector.</code><code class="sig-name descname">EventDetector</code><span class="sig-paren">(</span><em class="sig-param">path_to_data: pathlib.Path</em><span class="sig-paren">)</span><a class="headerlink" href="#src.analysis.event_detector.EventDetector" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>A flexible method for detecting events and calculating the size of runs
in a timeseries of interest.</p>
<p>an EventDetector object calculates the climatology and threshold values
(per pixel) and then can compute another xr.Dataset of <cite>runs</cite> which
are consecutive periods of threshold exceedence (above/below).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">path_to_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/interim/chirps_preprocessed/chirps_kenya.nc&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span> <span class="o">=</span> <span class="n">EventDetector</span><span class="p">(</span><span class="n">path_to_data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="s1">&#39;precip&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">time_period</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">hilo</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span><span class="o">.</span><span class="n">calculate_runs</span><span class="p">()</span>
</pre></div>
</div>
<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.calculate_longest_run">
<code class="sig-name descname">calculate_longest_run</code><span class="sig-paren">(</span><em class="sig-param">resample_str: Optional[str] = None</em><span class="sig-paren">)</span> &#x2192; xarray.core.dataset.Dataset<a class="headerlink" href="#src.analysis.event_detector.EventDetector.calculate_longest_run" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate the longest run in the dataset
TODO: fix this argument to work with other resample_str</p>
</dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.calculate_runs">
<code class="sig-name descname">calculate_runs</code><span class="sig-paren">(</span><span class="sig-paren">)</span> &#x2192; xarray.core.dataset.Dataset<a class="headerlink" href="#src.analysis.event_detector.EventDetector.calculate_runs" title="Permalink to this definition">¶</a></dt>
<dd><p>use xclim to calculate the number of consecutive exceedences.
For each pixel-time calculate the <cite>run</cite> of exceedences at the
current timestep.</p>
<dl>
<dt>e.g.</dt><dd><p>[True, True, False, True, False, True, True, True] =&gt;
[1, 2, 0, 1, 0, 1, 2, 3]</p>
<p>TODO: want to make this general enough to work with subset data too</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.calculate_threshold">
<em class="property">static </em><code class="sig-name descname">calculate_threshold</code><span class="sig-paren">(</span><em class="sig-param">ds: xarray.core.dataset.Dataset</em>, <em class="sig-param">clim: xarray.core.dataset.Dataset</em>, <em class="sig-param">method: str</em>, <em class="sig-param">time_period: str</em>, <em class="sig-param">variable: str</em>, <em class="sig-param">hilo: Optional[str] = None</em>, <em class="sig-param">value: Optional[float] = None</em><span class="sig-paren">)</span> &#x2192; xarray.core.dataarray.DataArray<a class="headerlink" href="#src.analysis.event_detector.EventDetector.calculate_threshold" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate the threshold using the method defined in <cite>method</cite>.
This calculates a threshold value above/below which a value is
defined as anomalous and therefore, set to true. Compared against
a reference climatology in methods [“q90”,”q10”,”std”]. Compared
against an absolute value in method [“abs”]</p>
<dl class="simple">
<dt>ds: xr.Dataset</dt><dd><p>dataset that you want to calculate the threshold for</p>
</dd>
<dt>clim: xr.Dataset</dt><dd><p>the climatology dataset</p>
</dd>
<dt>method: str</dt><dd><p>the method used to create the threshold values
{“q90”,”q10”,”std”,”abs”,}</p>
</dd>
<dt>time_period: str</dt><dd><p>the time period to groupby
{‘daysofyear’, ‘month’, ‘year’, ‘season’}</p>
</dd>
<dt>variable: str</dt><dd><p>the name of the variable in <cite>ds</cite></p>
</dd>
<dt>hilo: Optional[str] = None</dt><dd><p>Whether we are calculating the value above or below the threshold.
REQUIRED for <cite>method</cite> == ‘std’
{‘high’, ‘low’}</p>
</dd>
<dt>value: Optional[float] = None</dt><dd><p>if the method is <cite>abs</cite> then also need to provide a value to
be used as the threshold value.</p>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.calculate_threshold_exceedences">
<code class="sig-name descname">calculate_threshold_exceedences</code><span class="sig-paren">(</span><em class="sig-param">variable: str</em>, <em class="sig-param">time_period: str</em>, <em class="sig-param">hilo: str</em>, <em class="sig-param">method: str = 'std'</em>, <em class="sig-param">value: Optional[float] = None</em><span class="sig-paren">)</span> &#x2192; Tuple[Any, Any, Any]<a class="headerlink" href="#src.analysis.event_detector.EventDetector.calculate_threshold_exceedences" title="Permalink to this definition">¶</a></dt>
<dd><p>Flag the pixel-times that exceed a threshold defined via
the <cite>method</cite> argument.</p>
</dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.detect">
<code class="sig-name descname">detect</code><span class="sig-paren">(</span><em class="sig-param">variable: str</em>, <em class="sig-param">time_period: str</em>, <em class="sig-param">hilo: str</em>, <em class="sig-param">method: str = 'std'</em>, <em class="sig-param">value: Optional[float] = None</em><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.analysis.event_detector.EventDetector.detect" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>variable: str</dt><dd><p>name of the variable that you are comparing to the climatology</p>
</dd>
<dt>time_period: str</dt><dd><dl class="simple">
<dt>the period string used to calculate the climatology and define</dt><dd><p>the time
time_period = {‘dayofyear’, ‘season’, ‘month’}</p>
</dd>
</dl>
</dd>
<dt>hilo: str</dt><dd><dl class="simple">
<dt>are you looking for exceedences above a threshold = ‘high’</dt><dd><p>or below a threshold = ‘low’.
Valid values: {‘high’,’low’}.</p>
</dd>
</dl>
</dd>
<dt>method: str</dt><dd><dl class="simple">
<dt>How you want to calculate the threshold to flag exceedences</dt><dd><p>Valid values: {‘q90’, ‘q10’, ‘std’, ‘abs’,}</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.get_thresh_clim_dataarrays">
<code class="sig-name descname">get_thresh_clim_dataarrays</code><span class="sig-paren">(</span><em class="sig-param">ds: xarray.core.dataset.Dataset</em>, <em class="sig-param">time_period: str</em>, <em class="sig-param">variable: str</em>, <em class="sig-param">hilo: str = None</em>, <em class="sig-param">method: str = 'std'</em>, <em class="sig-param">value: Optional[float] = None</em><span class="sig-paren">)</span> &#x2192; Tuple[xarray.core.dataset.Dataset, xarray.core.dataset.Dataset]<a class="headerlink" href="#src.analysis.event_detector.EventDetector.get_thresh_clim_dataarrays" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the climatology and threshold xarray objects</p>
</dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.read_data">
<code class="sig-name descname">read_data</code><span class="sig-paren">(</span><em class="sig-param">path_to_data: pathlib.Path</em><span class="sig-paren">)</span> &#x2192; xarray.core.dataset.Dataset<a class="headerlink" href="#src.analysis.event_detector.EventDetector.read_data" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="src.analysis.event_detector.EventDetector.reapply_mask_to_boolean_xarray">
<code class="sig-name descname">reapply_mask_to_boolean_xarray</code><span class="sig-paren">(</span><em class="sig-param">variable_of_mask: str</em>, <em class="sig-param">da: xarray.core.dataarray.DataArray</em><span class="sig-paren">)</span> &#x2192; xarray.core.dataarray.DataArray<a class="headerlink" href="#src.analysis.event_detector.EventDetector.reapply_mask_to_boolean_xarray" title="Permalink to this definition">¶</a></dt>
<dd><p>Because boolean comparisons in xarray return False for nan values
we need to reapply the mask from the original <cite>da</cite> to mask out the sea
or invalid values (for example).</p>
<dl class="simple">
<dt>variable_of_mask: str</dt><dd><p>the variable that you want to use in <cite>self.ds</cite> as the mask.
The <cite>np.nan</cite> values in <cite>self.ds[variable]</cite> will be marked as <cite>True</cite></p>
</dd>
<dt>da: xr.DataArray</dt><dd><p>the boolean DataArray (for example <cite>self.exceedences</cite>) to reapply
the mask to</p>
</dd>
</dl>
<p>xr.DataArray with dtype of <cite>int</cite>, because <cite>bool</cite> dtype doesn’t store
masks / nan values very well.</p>
<dl>
<dt>NOTE:</dt><dd><ol class="arabic simple">
<li><p>Uses the input dataset for the mask - TODO: does this make</p></li>
</ol>
<blockquote>
<div><p>sense?</p>
</div></blockquote>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-src.analysis.plot_shap">
<span id="src-analysis-plot-shap-module"></span><h2>src.analysis.plot_shap module<a class="headerlink" href="#module-src.analysis.plot_shap" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="src.analysis.plot_shap.plot_shap_values">
<code class="sig-prename descclassname">src.analysis.plot_shap.</code><code class="sig-name descname">plot_shap_values</code><span class="sig-paren">(</span><em class="sig-param">x: numpy.ndarray, shap_values: numpy.ndarray, val_list: List[str], normalizing_dict: Dict[str, Dict[str, float]], value_to_plot: str, normalize_shap_plots: bool = True, show: bool = False</em><span class="sig-paren">)</span> &#x2192; None<a class="headerlink" href="#src.analysis.plot_shap.plot_shap_values" title="Permalink to this definition">¶</a></dt>
<dd><p>Plots the denormalized values against their shap values, so that
variations in the input features to the model can be compared to their effect
on the model. For example plots, see notebooks/08_gt_recurrent_model.ipynb.
Parameters:
———-
x: np.array</p>
<blockquote>
<div><p>The input to a model for a single data instance</p>
</div></blockquote>
<dl class="simple">
<dt>shap_values: np.array</dt><dd><p>The corresponding shap values (to x)</p>
</dd>
<dt>val_list: list</dt><dd><p>A list of the variable names, for axis labels</p>
</dd>
<dt>normalizing_dict: dict</dt><dd><p>The normalizing dict saved by the <cite>Engineer</cite>, so that the x array can be
denormalized</p>
</dd>
<dt>value_to_plot: str</dt><dd><p>The specific input variable to plot. Must be in val_list</p>
</dd>
<dt>normalize_shap_plots: bool = True</dt><dd><p>If True, then the scale of the shap plots will be uniform across all
variable plots (on an instance specific basis).</p>
</dd>
<dt>show: bool = False</dt><dd><p>If True, a plot of the variable <cite>value_to_plot</cite> against its shap values will be plotted.</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-contents">
<h2>Module contents<a class="headerlink" href="#module-contents" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">ml_drought</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Tommy Lees, Gabriel Tseng.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/source/src.analysis.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>